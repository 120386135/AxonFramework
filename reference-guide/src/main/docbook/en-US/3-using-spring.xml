<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright (c) 2010. Axon Framework
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<chapter id="using-spring" xmlns="http://docbook.org/ns/docbook">
    <title>Using Spring</title>
    <para>The AxonFramework has many integration points with the Spring Framework. All major
        building blocks in Axon are Spring configurable. Furthermore, there are some Bean Post
        Processors that scan the application context for building blocks and automatically wires
        them.</para>
    <sect1>
        <title>Wiring event handlers</title>
        <para>Using the annotated event listeners is very easy when you use Spring. All you need to
            do is configure the <code>AnnotationEventListenerBeanPostProcessor</code> in your
            application context. This post processor will discover beans with @EventHandler
            annotated methods and automatically connect them to the event bus.<programlistingco>
                <areaspec>
                    <area xml:id="postprocessor-co" coords="3 67"/>
                    <area xml:id="optional-eventbus-reference-co" coords="4 52"/>
                    <area xml:id="eventlistener-co" coords="7 76"/>
                </areaspec>
                <programlisting language="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans">

    &lt;bean class="org...AnnotationEventListenerBeanPostProcessor">
        &lt;property name="eventBus" ref="eventBus"/>
    &lt;/bean>

    &lt;bean class="org.axonframework.sample.app.query.AddressTableUpdater"/>

&lt;/beans></programlisting>
                <calloutlist>
                    <callout arearefs="postprocessor-co">
                        <para>This bean post processor will scan the application context for beans
                            with an <code>@EventHandler</code> annotated method.</para>
                    </callout>
                    <callout arearefs="optional-eventbus-reference-co">
                        <para>The reference to the event bus is optional, if only a single
                                <code>EventBus</code> implementation is configured in the
                            application context. The bean postprocessor will automatically find and
                            wire it. If there is more than one <code>EventBus</code> in the context,
                            you must specify the one to use in the postprocessor.</para>
                    </callout>
                    <callout arearefs="eventlistener-co">
                        <para>This event listener will be automatically recognized and subscribed to
                            the event bus.</para>
                    </callout>
                </calloutlist>
            </programlistingco></para>
        <para>You can also wire event listeners "manually", by explicitly defining them within a
                <code>AnnotationEventListenerAdapter</code> bean, as shown in the code sample below.<programlistingco>
                <areaspec>
                    <area xml:id="adapter-co" coords="3 82"/>
                    <area xml:id="eventbus-reference-co" coords="7 52"/>
                </areaspec>
                <programlisting language="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans">

    &lt;bean class="org.axonframework...annotation.AnnotationEventListenerAdapter">
        &lt;constructor-arg>
            &lt;bean class="org.axonframework.sample.app.query.AddressTableUpdater"/>
        &lt;/constructor-arg>
        &lt;property name="eventBus" ref="eventBus"/>
    &lt;/bean>

&lt;/beans></programlisting>
                <calloutlist>
                    <callout arearefs="adapter-co">
                        <para>The adapter turns any bean with <code>@EventHandler</code> methods
                            into an <code>EventListener</code></para>
                    </callout>
                    <callout arearefs="eventbus-reference-co">
                        <para>You need to explicitly reference the event bus to which you like to
                            register the event listener</para>
                    </callout>
                </calloutlist>
            </programlistingco></para>
        <warning>
            <para>Be careful when wiring event listeners "manually" while there is also an
                    <code>AnnotationEventListenerBeanPostProcessor</code> in the application
                context. This will cause the event listener to be wired twice.</para>
        </warning>
    </sect1>
    <sect1>
        <title>Wiring the event bus</title>
        <para>In a typical Axon application, there is only one event bus. Wiring it is just a matter
            of creating a bean of a subtype of <code>EventBus</code>. The
            <code>AsyncEventBus</code>, the default implementation of choice, also takes an optional
            executor property for the event processing.<programlistingco>
                <areaspec>
                    <area xml:id="eventbus-config-co" coords="3 84"/>
                    <area xml:id="taskexecutor-config-co" coords="7 103"/>
                    <area xml:id="wait-on-shutdown-co" coords="10 74"/>
                </areaspec>
                <programlisting language="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans">

    &lt;bean id="eventBus" class="org.axonframework.core.eventhandler.AsyncEventBus">
        &lt;property name="executor" ref="taskExecutor"/>
    &lt;/bean>

    &lt;bean id="taskExecutor" class="org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor">
        &lt;property name="corePoolSize" value="20"/>
        &lt;property name="maxPoolSize" value="100"/>
        &lt;property name="waitForTasksToCompleteOnShutdown" value="true"/>
    &lt;/bean>

&lt;/beans></programlisting>
                <calloutlist>
                    <callout arearefs="eventbus-config-co">
                        <para>Bean definition of the event bus to use. In this case, the
                            asynchronous event bus implementation is used.</para>
                    </callout>
                    <callout arearefs="taskexecutor-config-co">
                        <para>Instead of using the default task executor, you can define your own to
                            get more control over the number of threads to create. In this sample,
                            we define one of Spring's executor implementations, which uses a thread
                            pool.</para>
                    </callout>
                    <callout arearefs="wait-on-shutdown-co">
                        <para>This property ensures that the events that are in the dispatching
                            process are handled before the executor is shut down. This help ensure
                            that all events are processed, even when the application is
                            stopped.</para>
                    </callout>
                </calloutlist>
            </programlistingco></para>
        <para/>
    </sect1>
    <sect1>
        <title>Wiring the Repository</title>
        <para>This is how</para>
    </sect1>
</chapter>
